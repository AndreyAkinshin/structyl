name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GOTOOLCHAIN: local
  MISE_EXPERIMENTAL: 1

jobs:
  ci:
    name: CI
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up mise
        uses: jdx/mise-action@v2

      - name: Download dependencies
        run: mise run restore

      - name: Run linter
        run: mise run check:lint

      - name: Validate schemas
        run: mise run check:schema

      - name: Run tests
        id: test
        shell: bash
        run: |
          set +e
          go test -json -race ./... 2>&1 | tee test-output.json
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Test summary
        if: always() && steps.test.outcome != 'skipped'
        run: go run ./cmd/structyl test-summary test-output.json

      - name: Check test result
        if: always() && steps.test.outcome != 'skipped'
        shell: bash
        run: |
          if [ "${{ steps.test.outputs.exit_code }}" != "0" ]; then
            exit 1
          fi

      - name: Build
        run: mise run build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: structyl-${{ matrix.os }}
          path: structyl*

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up mise
        uses: jdx/mise-action@v2

      - name: Run tests with coverage
        run: mise run test:cover

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage.out
          fail_ci_if_error: false

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up mise
        uses: jdx/mise-action@v2

      - name: Check for vulnerabilities
        run: mise run security:vuln

      - name: Run static security analysis
        run: mise run security:gosec
