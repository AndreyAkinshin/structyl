name: Nightly

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

env:
  GOTOOLCHAIN: local
  MISE_EXPERIMENTAL: 1

jobs:
  nightly:
    name: Nightly Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up mise
        uses: jdx/mise-action@v2
        with:
          install_args: "go@1.24"

      - name: Get version info
        id: version
        run: |
          # Version format must match what GoReleaser produces with --snapshot and GORELEASER_CURRENT_TAG=nightly
          # GoReleaser produces: nightly-SNAPSHOT-{SHORT_SHA}
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "version=nightly-SNAPSHOT-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Building nightly version: nightly-SNAPSHOT-${SHORT_SHA}"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: nightly

      - name: Rename archives for nightly
        run: |
          cd dist
          # Rename snapshot archives to nightly naming
          for f in structyl_*-SNAPSHOT-*; do
            if [ -f "$f" ]; then
              # Extract os and arch from filename
              # Format: structyl_VERSION-SNAPSHOT-SHA_os_arch.ext
              newname=$(echo "$f" | sed -E 's/structyl_[^_]+-SNAPSHOT-[^_]+_/structyl_nightly_/')
              mv "$f" "$newname"
              echo "Renamed $f -> $newname"
            fi
          done

          # Regenerate checksums with new names
          rm -f checksums.txt
          sha256sum structyl_nightly_* > checksums.txt
          cat checksums.txt

      - name: Delete existing nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Only delete after successful build to preserve old release on failure
          gh release delete nightly --yes --cleanup-tag || true

      - name: Create nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          gh release create nightly \
            --title "Nightly Build" \
            --notes "Automated nightly build from main branch.

          **Version:** \`$VERSION\`
          **Commit:** [\`${GITHUB_SHA::7}\`](https://github.com/${{ github.repository }}/commit/$GITHUB_SHA)
          **Built:** $(date -u '+%Y-%m-%d %H:%M UTC')

          > ⚠️ This is an unstable development build. Use for testing only.

          ## Install

          \`\`\`bash
          curl -fsSL https://get.structyl.akinshin.dev/install.sh | sh -s -- --version nightly
          \`\`\`" \
            --prerelease \
            dist/structyl_nightly_*.tar.gz \
            dist/structyl_nightly_*.zip \
            dist/checksums.txt
