#!/bin/bash
#MISE description="Create a release tag (usage: mise run publish <version> [--push])"
set -e

VERSION="${1:-}"
PUSH=false

if [ -z "$VERSION" ]; then
    echo "error: version argument required"
    echo "usage: mise run publish <version> [--push]"
    echo "example: mise run publish 0.1.0"
    echo "         mise run publish 0.1.0 --push"
    exit 1
fi

if [ "$2" = "--push" ]; then
    PUSH=true
fi

# Strip v prefix if present (support both "0.1.0" and "v0.1.0")
VERSION="${VERSION#v}"

# Validate semver format (X.Y.Z with optional pre-release)
if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
    echo "error: invalid version format: $VERSION"
    echo "expected: X.Y.Z (e.g., 0.1.0, 1.0.0-beta.1)"
    exit 1
fi

TAG="v$VERSION"

# Check if tag already exists
if git rev-parse "$TAG" >/dev/null 2>&1; then
    echo "error: tag $TAG already exists"
    exit 1
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "error: uncommitted changes detected"
    echo "commit or stash changes before releasing"
    exit 1
fi

echo "Creating tag: $TAG"
git tag "$TAG"

if [ "$PUSH" = true ]; then
    echo "Pushing tag to origin..."
    git push origin "$TAG"
    echo ""
    echo "Release $TAG created and pushed!"
    echo "GitHub Actions will build and publish the release."
    echo "Monitor at: https://github.com/AndreyAkinshin/structyl/actions"
else
    echo ""
    echo "Tag $TAG created locally."
    echo "Run 'git push origin $TAG' to trigger the release."
fi
