# Structyl Project Guidelines

This project uses **Structyl** for multi-language build orchestration.

Structyl uses **mise** as its primary build platform. Commands are delegated to mise tasks, with `mise.toml` autogenerated from `config.json`.

## Configuration

Location: `.structyl/config.json`

## Build System

Structyl delegates all command execution to mise:

- `structyl build go` → `mise run build:go`
- `structyl test` → `mise run test`
- `structyl ci` → `mise run ci`

The `mise.toml` file is autogenerated and gitignored.

## Commands

### Meta Commands (all targets)

| Command            | Description               |
| ------------------ | ------------------------- |
| `structyl build`   | Build all targets         |
| `structyl test`    | Test all language targets |
| `structyl clean`   | Clean all targets         |
| `structyl restore` | Install dependencies      |
| `structyl check`   | Run static analysis       |
| `structyl check:fix` | Auto-fix static analysis issues |
| `structyl bench`   | Run benchmarks            |
| `structyl demo`    | Run demo code             |
| `structyl ci`      | Run full CI pipeline      |

### Target Commands

| Command                   | Description                     |
| ------------------------- | ------------------------------- |
| `structyl <cmd> <target>` | Run command for specific target |
| `structyl build <target>` | Build specific target           |
| `structyl test <target>`  | Test specific target            |

### Utility Commands

| Command                    | Description                      |
| -------------------------- | -------------------------------- |
| `structyl init`            | Initialize new project           |
| `structyl targets`         | List all targets                 |
| `structyl config validate` | Validate configuration           |
| `structyl mise sync`       | Regenerate mise.toml            |
| `structyl release`         | Set version, commit, and tag     |
| `structyl docker-build`    | Build Docker images              |
| `structyl docker-clean`    | Clean Docker artifacts           |
| `structyl dockerfile`      | Generate Dockerfiles with mise   |
| `structyl github`          | Generate GitHub Actions workflow |

## Configuration Format

```json
{
  "project": { "name": "project-name" },
  "targets": {
    "rs": { "type": "language", "title": "Rust", "toolchain": "cargo" },
    "py": { "type": "language", "title": "Python", "toolchain": "python" }
  }
}
```

## Target Types

- **language**: Code implementations (participates in `structyl test`)
- **auxiliary**: Supporting tasks (docs, images)

## Supported Toolchains

| Toolchain  | Ecosystem       |
| ---------- | --------------- |
| `cargo`    | Rust            |
| `go`       | Go              |
| `dotnet`   | .NET (C#, F#)   |
| `npm`      | Node.js (npm)   |
| `pnpm`     | Node.js (pnpm)  |
| `yarn`     | Node.js (Yarn)  |
| `bun`      | Bun             |
| `deno`     | Deno            |
| `python`   | Python (pip)    |
| `uv`       | Python (uv)     |
| `poetry`   | Python (Poetry) |
| `gradle`   | JVM (Gradle)    |
| `maven`    | JVM (Maven)     |
| `sbt`      | Scala           |
| `swift`    | Swift           |
| `cmake`    | C/C++           |
| `make`     | Generic         |
| `bundler`  | Ruby            |
| `composer` | PHP             |
| `mix`      | Elixir          |
| `cabal`    | Haskell (Cabal) |
| `stack`    | Haskell (Stack) |
| `dune`     | OCaml           |
| `lein`     | Clojure         |
| `zig`      | Zig             |
| `rebar3`   | Erlang          |
| `r`        | R               |

## Custom Commands

Commands can be defined as shell strings or arrays.

### Shell String

```json
{
  "targets": {
    "img": {
      "type": "auxiliary",
      "commands": {
        "build": "python scripts/generate.py",
        "clean": "rm -rf output/"
      }
    }
  }
}
```

### Override Toolchain Commands

```json
{
  "targets": {
    "cs": {
      "toolchain": "dotnet",
      "commands": {
        "test": "dotnet run --project MyLib.Tests"
      }
    }
  }
}
```

### Command Composition (sequential)

```json
{
  "commands": {
    "check": ["cargo clippy -- -D warnings", "cargo fmt --check"],
    "ci": ["restore", "check", "build", "test"]
  }
}
```

### Disable Command

```json
{ "commands": { "bench": null } }
```

## Dependencies

Use `depends_on` to specify build order:

```json
{ "bindings": { "toolchain": "python", "depends_on": ["core"] } }
```

## Docker Mode

```bash
structyl build --docker
# or: export STRUCTYL_DOCKER=1
```

## Exit Codes

| Code | Meaning                           |
| ---- | --------------------------------- |
| 0    | Success                           |
| 1    | Runtime error (command failed)    |
| 2    | Configuration error               |
| 3    | Environment error (missing tools) |
