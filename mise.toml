[tools]
go = "1.24"
node = "22"
pnpm = "10"
golangci-lint = "latest"
goreleaser = "latest"
"go:golang.org/x/vuln/cmd/govulncheck" = "latest"
"go:github.com/securego/gosec/v2/cmd/gosec" = "latest"

# ==========================================================================
# Standard Tasks (see build-system.md for conventions)
# ==========================================================================

[tasks.restore]
description = "Restore all dependencies"
run = "go mod download"

[tasks.build]
description = "Build the structyl binary"
run = "go build -v ./cmd/structyl"

[tasks.test]
description = "Run all tests"
run = "go test -v -race ./..."

[tasks.check]
description = "Run all static analysis (lint, format, schema validation)"
depends = ["check:lint", "check:schema"]

[tasks."check:fix"]
description = "Auto-fix formatting issues"
run = "golangci-lint fmt"

[tasks.clean]
description = "Remove build artifacts"
run = "rm -f structyl coverage.out coverage.html"

[tasks.ci]
description = "Run full CI pipeline"
run = [
    { task = "clean" },
    { task = "restore" },
    { task = "check" },
    { task = "build" },
    { task = "test" },
]

# ==========================================================================
# Check Tasks
# ==========================================================================

[tasks."check:lint"]
description = "Run golangci-lint (includes format verification)"
run = "golangci-lint run"

[tasks."check:schema"]
description = "Validate JSON files against schemas"
run = "go test -v -run TestSchema ./internal/schema/..."

# ==========================================================================
# Test Tasks
# ==========================================================================

[tasks."test:unit"]
description = "Run unit tests"
run = "go test -v -race ./internal/..."

[tasks."test:integration"]
description = "Run integration tests"
run = "go test -v -race ./test/integration/..."

[tasks."test:pkg"]
description = "Run package tests"
run = "go test -v -race ./pkg/..."

[tasks."test:cover"]
description = "Run tests with coverage"
run = "go test -race -coverprofile=coverage.out -covermode=atomic ./..."

[tasks."test:bench"]
description = "Run benchmark tests"
run = "go test -bench=. -benchmem ./..."

[tasks."test:fuzz"]
description = "Run fuzz tests (30s each)"
run = """
go test -fuzz=FuzzGoParser -fuzztime=30s ./internal/testparser/
go test -fuzz=FuzzCargoParser -fuzztime=30s ./internal/testparser/
go test -fuzz=FuzzDotnetParser -fuzztime=30s ./internal/testparser/
go test -fuzz=FuzzPytestParser -fuzztime=30s ./internal/testparser/
go test -fuzz=FuzzBunParser -fuzztime=30s ./internal/testparser/
go test -fuzz=FuzzDenoParser -fuzztime=30s ./internal/testparser/
go test -fuzz=FuzzJSONParser -fuzztime=30s ./internal/testparser/
"""

# ==========================================================================
# Coverage Tasks
# ==========================================================================

[tasks."cover:report"]
description = "Generate HTML coverage report"
run = "go tool cover -html=coverage.out -o coverage.html"

[tasks."cover:view"]
description = "Open coverage report in browser"
run = "open coverage.html"

# ==========================================================================
# Security Tasks
# ==========================================================================

[tasks.security]
description = "Run all security checks"
depends = ["security:vuln", "security:gosec"]

[tasks."security:vuln"]
description = "Check for known vulnerabilities in dependencies"
run = "govulncheck ./..."

[tasks."security:gosec"]
description = "Run static security analysis"
# Exclusions:
#   G107: URL provided to HTTP request (tool fetches user-specified URLs by design)
#   G115: Integer overflow conversion (intentional for ULP float comparison)
#   G204: Subprocess with variable (core functionality - executes user commands)
#   G301: Directory permissions 0755 (standard for user-accessible directories)
#   G304: File path from variable (CLI tool reads user-specified files by design)
#   G306: WriteFile permissions 0644 (standard for config files)
run = "gosec -quiet -exclude=G107,G115,G204,G301,G304,G306 ./..."

# ==========================================================================
# Documentation Tasks
# ==========================================================================

[tasks."docs:dev"]
description = "Start documentation dev server"
dir = "docs"
run = "pnpm dev"

[tasks."docs:build"]
description = "Build documentation site"
dir = "docs"
run = "pnpm build"

[tasks."docs:preview"]
description = "Preview built documentation site"
dir = "docs"
run = "pnpm preview"

[tasks."docs:restore"]
description = "Install documentation dependencies"
dir = "docs"
run = "pnpm install"

# ==========================================================================
# Release Tasks
# ==========================================================================

[tasks.release]
description = "Create and push a release tag (usage: mise run release <version>)"
run = """
#!/bin/bash
set -e

VERSION="${1:-}"

if [ -z "$VERSION" ]; then
    echo "error: version argument required"
    echo "usage: mise run release <version>"
    echo "example: mise run release 0.1.0"
    exit 1
fi

# Strip v prefix if present (support both "0.1.0" and "v0.1.0")
VERSION="${VERSION#v}"

# Validate semver format (X.Y.Z with optional pre-release)
if ! echo "$VERSION" | grep -qE '^[0-9]+\\.[0-9]+\\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
    echo "error: invalid version format: $VERSION"
    echo "expected: X.Y.Z (e.g., 0.1.0, 1.0.0-beta.1)"
    exit 1
fi

TAG="v$VERSION"

# Check if tag already exists
if git rev-parse "$TAG" >/dev/null 2>&1; then
    echo "error: tag $TAG already exists"
    exit 1
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "error: uncommitted changes detected"
    echo "commit or stash changes before releasing"
    exit 1
fi

echo "Creating tag: $TAG"
git tag "$TAG"

echo "Pushing tag to origin..."
git push origin "$TAG"

echo ""
echo "Release $TAG created and pushed!"
echo "GitHub Actions will build and publish the release."
echo "Monitor at: https://github.com/AndreyAkinshin/structyl/actions"
"""
