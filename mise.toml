[tools]
go = "1.24"
node = "22"
pnpm = "10"
golangci-lint = "latest"
goreleaser = "latest"
"go:golang.org/x/vuln/cmd/govulncheck" = "latest"
"go:github.com/securego/gosec/v2/cmd/gosec" = "latest"

# ==========================================================================
# Standard Tasks (see build-system.md for conventions)
# ==========================================================================

[tasks.restore]
description = "Restore all dependencies"
run = "go mod download"

[tasks.build]
description = "Build the structyl binary"
run = "go build -v ./cmd/structyl"

[tasks.test]
description = "Run all tests"
run = "go test -v -race ./..."

[tasks.check]
description = "Run all static analysis (lint, format, schema validation)"
depends = ["check:lint", "check:schema"]

[tasks."check:fix"]
description = "Auto-fix formatting issues"
run = "golangci-lint fmt"

[tasks.clean]
description = "Remove build artifacts"
run = "rm -f structyl coverage.out coverage.html"

[tasks.ci]
description = "Run full CI pipeline"
run = [
    { task = "clean" },
    { task = "restore" },
    { task = "check" },
    { task = "build" },
    { task = "test" },
]

# ==========================================================================
# Check Tasks
# ==========================================================================

[tasks."check:lint"]
description = "Run golangci-lint (includes format verification)"
run = "golangci-lint run"

[tasks."check:schema"]
description = "Validate JSON files against schemas"
run = "go test -v -run TestSchema ./internal/schema/..."

# ==========================================================================
# Test Tasks
# ==========================================================================

[tasks."test:unit"]
description = "Run unit tests"
run = "go test -v -race ./internal/..."

[tasks."test:integration"]
description = "Run integration tests"
run = "go test -v -race ./test/integration/..."

[tasks."test:pkg"]
description = "Run package tests"
run = "go test -v -race ./pkg/..."

[tasks."test:cover"]
description = "Run tests with coverage"
run = "go test -race -coverprofile=coverage.out -covermode=atomic ./..."

# ==========================================================================
# Coverage Tasks
# ==========================================================================

[tasks."cover:report"]
description = "Generate HTML coverage report"
run = "go tool cover -html=coverage.out -o coverage.html"

[tasks."cover:view"]
description = "Open coverage report in browser"
run = "open coverage.html"

# ==========================================================================
# Security Tasks
# ==========================================================================

[tasks.security]
description = "Run all security checks"
depends = ["security:vuln", "security:gosec"]

[tasks."security:vuln"]
description = "Check for known vulnerabilities in dependencies"
run = "govulncheck ./..."

[tasks."security:gosec"]
description = "Run static security analysis"
# Exclusions:
#   G107: URL provided to HTTP request (tool fetches user-specified URLs by design)
#   G115: Integer overflow conversion (intentional for ULP float comparison)
#   G204: Subprocess with variable (core functionality - executes user commands)
#   G301: Directory permissions 0755 (standard for user-accessible directories)
#   G304: File path from variable (CLI tool reads user-specified files by design)
#   G306: WriteFile permissions 0644 (standard for config files)
run = "gosec -quiet -exclude=G107,G115,G204,G301,G304,G306 ./..."

# ==========================================================================
# Documentation Tasks
# ==========================================================================

[tasks."docs:dev"]
description = "Start documentation dev server"
dir = "docs"
run = "pnpm dev"

[tasks."docs:build"]
description = "Build documentation site"
dir = "docs"
run = "pnpm build"

[tasks."docs:preview"]
description = "Preview built documentation site"
dir = "docs"
run = "pnpm preview"

[tasks."docs:restore"]
description = "Install documentation dependencies"
dir = "docs"
run = "pnpm install"
